<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/default.min.css">
 <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
 <script>hljs.highlightAll();</script>
<h3>–¢–∏–ø–∏ —Ä–æ–∑—É–º–Ω–∏—Ö –≤–∫–∞–∑—ñ–≤–Ω–∏–∫—ñ–≤</h3>

<table class="smart-pointers">
  <tr>
    <th>–¢–∏–ø</th>
    <th>–í–ª–∞—Å–Ω—ñ—Å—Ç—å</th>
    <th>–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è</th>
  </tr>
  <tr>
    <td><code>unique_ptr</code></td>
    <td>–ï–∫—Å–∫–ª—é–∑–∏–≤–Ω–∞</td>
    <td>–Ñ–¥–∏–Ω–∏–π –≤–ª–∞—Å–Ω–∏–∫ —Ä–µ—Å—É—Ä—Å—É</td>
  </tr>
  <tr>
    <td><code>shared_ptr</code></td>
    <td>–°–ø—ñ–ª—å–Ω–∞</td>
    <td>–ö—ñ–ª—å–∫–∞ –≤–ª–∞—Å–Ω–∏–∫—ñ–≤ —á–µ—Ä–µ–∑ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø–æ—Å–∏–ª–∞–Ω—å</td>
  </tr>
  <tr>
    <td><code>weak_ptr</code></td>
    <td>–ù–µ–º–∞—î</td>
    <td>–°–ø–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–Ω—è –±–µ–∑ –≤–ø–ª–∏–≤—É –Ω–∞ –ª—ñ—á–∏–ª—å–Ω–∏–∫</td>
  </tr>
</table>

<h3>–†—ñ–∑–Ω–∏—Ü—è –º—ñ–∂ unique_ptr —Ç–∞ shared_ptr</h3>

<table class="pointer-comparison">
  <tr>
    <th>–ö—Ä–∏—Ç–µ—Ä—ñ–π</th>
    <th>unique_ptr</th>
    <th>shared_ptr</th>
  </tr>
  <tr>
    <td>–í–ª–∞—Å–Ω—ñ—Å—Ç—å</td>
    <td>–Ñ–¥–∏–Ω–∏–π –≤–ª–∞—Å–Ω–∏–∫</td>
    <td>–°–ø—ñ–ª—å–Ω–∞ –≤–ª–∞—Å–Ω—ñ—Å—Ç—å (multiple owners)</td>
  </tr>
  <tr>
    <td>–®–≤–∏–¥–∫—ñ—Å—Ç—å</td>
    <td>–®–≤–∏–¥—à–∏–π (–Ω–µ–º–∞—î –Ω–∞–∫–ª–∞–¥–Ω–∏—Ö –≤–∏—Ç—Ä–∞—Ç)</td>
    <td>–ü–æ–≤—ñ–ª—å–Ω—ñ—à–∏–π (–ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø–æ—Å–∏–ª–∞–Ω—å)</td>
  </tr>
  <tr>
    <td>–ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è</td>
    <td>–ù–µ–º–æ–∂–ª–∏–≤–µ</td>
    <td>–î–æ–∑–≤–æ–ª–µ–Ω–µ (–∑–±—ñ–ª—å—à—É—î –ª—ñ—á–∏–ª—å–Ω–∏–∫)</td>
  </tr>
</table>

<h4>unique_ptr: –ï–∫—Å–∫–ª—é–∑–∏–≤–Ω–∞ –≤–ª–∞—Å–Ω—ñ—Å—Ç—å</h4>
<pre><code class="language-cpp">// –°—Ç–≤–æ—Ä–µ–Ω–Ω—è unique_ptr
auto file = make_unique&lt;FileHandler&gt;("data.txt");

// –ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –≤–ª–∞—Å–Ω–æ—Å—Ç—ñ
auto newOwner = move(file); 

// –°–ø—Ä–æ–±–∞ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è (–ø–æ–º–∏–ª–∫–∞ –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó)
// auto copy = file; // Error: use of deleted function</code></pre>

<p><strong>–ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏:</strong></p>
<ul>
  <li>–ö–æ–ª–∏ —Ä–µ—Å—É—Ä—Å –º–∞—î —á—ñ—Ç–∫–æ –≤–∏–∑–Ω–∞—á–µ–Ω–æ–≥–æ —î–¥–∏–Ω–æ–≥–æ –≤–ª–∞—Å–Ω–∏–∫–∞</li>
  <li>–î–ª—è –≤–∏–∫–ª—é—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É –¥–æ —Ä–µ—Å—É—Ä—Å—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —Ñ–∞–π–ª–æ–≤—ñ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∏)</li>
  <li>–Ø–∫ –ø–æ–≤–µ—Ä–Ω–µ–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ —Ñ–∞–±—Ä–∏—á–Ω–∏—Ö –º–µ—Ç–æ–¥—ñ–≤</li>
</ul>

<h4>shared_ptr: –°–ø—ñ–ª—å–Ω–∞ –≤–ª–∞—Å–Ω—ñ—Å—Ç—å</h4>
<pre><code class="language-cpp">// –°—Ç–≤–æ—Ä–µ–Ω–Ω—è shared_ptr
auto sensor = make_shared&lt;TemperatureSensor&gt;();

// –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è - –ª—ñ—á–∏–ª—å–Ω–∏–∫ –∑–±—ñ–ª—å—à—É—î—Ç—å—Å—è –¥–æ 2
auto backup = sensor; 

{
  vector&lt;shared_ptr&lt;TemperatureSensor&gt;&gt; devices;
  devices.push_back(sensor); // –õ—ñ—á–∏–ª—å–Ω–∏–∫ = 3
} // –õ—ñ—á–∏–ª—å–Ω–∏–∫ = 2 –ø—Ä–∏ –≤–∏—Ö–æ–¥—ñ –∑ –æ–±–ª–∞—Å—Ç—ñ –≤–∏–¥–∏–º–æ—Å—Ç—ñ

// –ì—Ä—É–ø–∞ –æ–±'—î–∫—Ç—ñ–≤ —ñ–∑ —Å–ø—ñ–ª—å–Ω–∏–º —Ä–µ—Å—É—Ä—Å–æ–º
struct DeviceGroup {
  shared_ptr&lt;Config&gt; config; // –°–ø—ñ–ª—å–Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
};</code></pre>

<p><strong>–ù–∞–≤—ñ—â–æ –ø–æ—Ç—Ä—ñ–±–µ–Ω shared_ptr:</strong></p>
<ul>
  <li>–ö–æ–ª–∏ —Ä–µ—Å—É—Ä—Å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –∫—ñ–ª—å–∫–æ–º–∞ –Ω–µ–∑–∞–ª–µ–∂–Ω–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏</li>
  <li>–î–ª—è —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó –∫–µ—à—ñ–≤ –∞–±–æ –ø—É–ª—ñ–≤ —Ä–µ—Å—É—Ä—Å—ñ–≤</li>
  <li>–£ –≤–∏–ø–∞–¥–∫–∞—Ö —ñ–∑ —Å–∫–ª–∞–¥–Ω–æ—é –∞–±–æ –¥–∏–Ω–∞–º—ñ—á–Ω–æ—é —Ç–æ–ø–æ–ª–æ–≥—ñ—î—é –æ–±'—î–∫—Ç—ñ–≤</li>
</ul>

<div class="analogy">
  <p><strong>–ê–Ω–∞–ª–æ–≥—ñ—è:</strong></p>
  <ul>
    <li>üîë <code>unique_ptr</code> - —è–∫ —î–¥–∏–Ω–∏–π –∫–ª—é—á –≤—ñ–¥ –∫—ñ–º–Ω–∞—Ç–∏</li>
    <li>üîëüóùÔ∏è <code>shared_ptr</code> - —è–∫ –∫—ñ–ª—å–∫–∞ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ –∫–ª—é—á—ñ–≤</li>
  </ul>
</div>

<h4>–ü–æ—Ä—ñ–≤–Ω—è–ª—å–Ω–∏–π –ø—Ä–∏–∫–ª–∞–¥</h4>
<pre><code class="language-cpp">// Unique_ptr: –ø–µ—Ä–µ–¥–∞—á–∞ –≤–ª–∞—Å–Ω–æ—Å—Ç—ñ
unique_ptr&lt;Task&gt; createTask() {
  return make_unique&lt;Task&gt;();
}
auto task = createTask(); // –í–ª–∞—Å–Ω—ñ—Å—Ç—å –ø–µ—Ä–µ–¥–∞–Ω–∞

// Shared_ptr: —Å–ø—ñ–ª—å–Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
class Processor {
  shared_ptr&lt;Logger&gt; logger;
public:
  Processor(shared_ptr&lt;Logger&gt; log) : logger(log) {}
};

auto logger = make_shared&lt;FileLogger&gt;();
Processor p1(logger), p2(logger); // –û–±–∏–¥–≤–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å –æ–¥–∏–Ω –ª–æ–≥–≥–µ—Ä</code></pre>

<div class="warning">
  <p><strong>–í–∞–∂–ª–∏–≤–æ:</strong></p>
  <ul>
    <li>–£–Ω–∏–∫–∞–π—Ç–µ —Ü–∏–∫–ª—ñ—á–Ω–∏—Ö –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π –∑ <code>shared_ptr</code></li>
    <li>–í–∏–±—ñ—Ä –º—ñ–∂ <code>unique_ptr</code> —Ç–∞ <code>shared_ptr</code> - —Ü–µ –¥–∏–∑–∞–π–Ω–µ—Ä—Å—å–∫–µ —Ä—ñ—à–µ–Ω–Ω—è</li>
    <li>–í—ñ–¥–¥–∞–≤–∞–π—Ç–µ –ø–µ—Ä–µ–≤–∞–≥—É <code>unique_ptr</code>, —è–∫—â–æ –º–æ–∂–ª–∏–≤–æ</li>
  </ul>
</div>

<h4>weak_ptr: –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è</h4>

<p><code>weak_ptr</code> –≤–∏—Ä—ñ—à—É—î –≥–æ–ª–æ–≤–Ω—É –ø—Ä–æ–±–ª–µ–º—É <code>shared_ptr</code> - —Ü–∏–∫–ª—ñ—á–Ω—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ. –†–æ–∑–≥–ª—è–Ω–µ–º–æ –ø—Ä–∏–∫–ª–∞–¥:</p>

<pre><code class="language-cpp">class Node {
public:
    shared_ptr&lt;Node&gt; next;
    shared_ptr&lt;Node&gt; prev; // –ü—Ä–æ–±–ª–µ–º–∞: —Ü–∏–∫–ª—ñ—á–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è!
};

shared_ptr&lt;Node&gt; node1 = make_shared&lt;Node&gt;();
shared_ptr&lt;Node&gt; node2 = make_shared&lt;Node&gt;();

node1->next = node2;
node2->prev = node1; // –õ—ñ—á–∏–ª—å–Ω–∏–∫–∏ –Ω—ñ–∫–æ–ª–∏ –Ω–µ —Å—Ç–∞–Ω—É—Ç—å –Ω—É–ª–µ–º!</code></pre>

<p><strong>–†—ñ—à–µ–Ω–Ω—è:</strong> –ó–∞–º—ñ–Ω–∏–º–æ –æ–¥–∏–Ω –∑ <code>shared_ptr</code> –Ω–∞ <code>weak_ptr</code>:</p>

<pre><code class="language-cpp">class FixedNode {
public:
    shared_ptr&lt;FixedNode&gt; next;
    weak_ptr&lt;FixedNode&gt; prev; // –†–æ–∑—Ä–∏–≤–∞—î–º–æ —Ü–∏–∫–ª!
};</code></pre>

<h4>–û—Å–Ω–æ–≤–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó –∑ weak_ptr</h4>

<pre><code class="language-cpp">shared_ptr&lt;int&gt; shared = make_shared&lt;int&gt;(42);

// –°—Ç–≤–æ—Ä–µ–Ω–Ω—è weak_ptr –∑ shared_ptr
weak_ptr&lt;int&gt; weak = shared; 

// –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –≤–∞–ª—ñ–¥–Ω—ñ—Å—Ç—å
if (!weak.expired()) {
    // –û—Ç—Ä–∏–º–∞–Ω–Ω—è shared_ptr –∑ weak_ptr
    shared_ptr&lt;int&gt; locked = weak.lock(); 
    *locked = 100; // –ë–µ–∑–ø–µ—á–Ω–∏–π –¥–æ—Å—Ç—É–ø
}</code></pre>

<h4>–ü—Ä–∞–∫—Ç–∏—á–Ω–µ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è: —Å–∏—Å—Ç–µ–º–∞ –∫–µ—à—É–≤–∞–Ω–Ω—è</h4>

<pre><code class="language-cpp">class Cache {
    unordered_map&lt;int, weak_ptr&lt;LargeObject&gt;&gt; cache;
    
    shared_ptr&lt;LargeObject&gt; get(int id) {
        if (auto it = cache.find(id); it != cache.end()) {
            if (auto obj = it->second.lock()) {
                return obj; // –û–±'—î–∫—Ç —â–µ —É –ø–∞–º'—è—Ç—ñ
            }
        }
        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ –¥–∏—Å–∫–∞
        auto obj = make_shared&lt;LargeObject&gt;(load_from_disk(id));
        cache[id] = obj;
        return obj;
    }
};</code></pre>

<div class="warning">
<p><strong>–í–∞–∂–ª–∏–≤—ñ –∑–∞—É–≤–∞–∂–µ–Ω–Ω—è:</strong></p>
<ul>
  <li>–ó–∞–≤–∂–¥–∏ –ø–µ—Ä–µ–≤—ñ—Ä—è–π—Ç–µ <code>expired()</code> –ø–µ—Ä–µ–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º</li>
  <li>–ù–µ –Ω–∞–º–∞–≥–∞–π—Ç–µ—Å—è —Ä–æ–∑—ñ–º–µ–Ω–æ–≤—É–≤–∞—Ç–∏ <code>weak_ptr</code> –Ω–∞–ø—Ä—è–º—É</li>
  <li>–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ <code>lock()</code> –¥–ª—è —Ç–∏–º—á–∞—Å–æ–≤–æ–≥–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –≤–ª–∞—Å–Ω–æ—Å—Ç—ñ</li>
</ul>
</div>

<h4>–ü–µ—Ä–µ–≤–∞–≥–∏ weak_ptr</h4>
<ul>
  <li>‚úÖ –ó–∞–ø–æ–±—ñ–≥–∞—î –≤–∏—Ç–æ–∫–∞–º –ø–∞–º'—è—Ç—ñ —á–µ—Ä–µ–∑ —Ü–∏–∫–ª—ñ—á–Ω—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ</li>
  <li>‚úÖ –î–æ–∑–≤–æ–ª—è—î —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –Ω–µ–∫–µ—Ä–æ–≤–∞–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</li>
  <li>‚úÖ –ù–µ –∑–±—ñ–ª—å—à—É—î –ª—ñ—á–∏–ª—å–Ω–∏–∫ –ø–æ—Å–∏–ª–∞–Ω—å <code>shared_ptr</code></li>
</ul>